"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireDefault(require("react"));

var _best = _interopRequireDefault(require("./best"));

var _Context = _interopRequireDefault(require("./Context"));

var _ScrollSpy = _interopRequireDefault(require("./ScrollSpy"));

var _ScrollTo = _interopRequireDefault(require("./ScrollTo"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

function _possibleConstructorReturn(self, call) { if (call && (_typeof(call) === "object" || typeof call === "function")) { return call; } return _assertThisInitialized(self); }

function _getPrototypeOf(o) { _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) { return o.__proto__ || Object.getPrototypeOf(o); }; return _getPrototypeOf(o); }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); }

function _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }

function _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return self; }

function getView(current, scrollingTo) {
  if (current) {
    var scrollLeft = scrollingTo || current.scrollLeft;
    var items = current.querySelectorAll('ul > li');
    var scrollCenter = scrollLeft + current.offsetWidth / 2;
    var index = (0, _best.default)([].slice.call(items), function (item) {
      var offsetCenter = item.offsetLeft + item.offsetWidth / 2;
      return 1 / Math.abs(scrollCenter - offsetCenter);
    });

    if (~index) {
      var item = items[index];
      var offsetCenter = item.offsetLeft + item.offsetWidth / 2;
      var indexFraction = index + (scrollCenter - offsetCenter) / item.offsetWidth; // We "fix" indexFraction if the viewport is at the start/end of the content
      // This is to simplify code that use Math.round(indexFraction) to find the current index
      // if (scrollLeft === 0) {
      //   indexFraction = 0;
      // } else if (scrollLeft >= current.scrollWidth - current.offsetWidth) {
      //   indexFraction = items.length - 1;
      // } else if (indexFraction % 1 > .99 || indexFraction % 1 < .01) {
      //   indexFraction = Math.round(indexFraction);
      // }

      if (indexFraction % 1 > .99 || indexFraction % 1 < .01) {
        indexFraction = Math.round(indexFraction);
      }

      var selectedIndex;

      if (scrollLeft === 0) {
        selectedIndex = 0;
      } else if (scrollLeft >= current.scrollWidth - current.offsetWidth) {
        selectedIndex = items.length - 1;
      } else {
        selectedIndex = Math.round(indexFraction);
      }

      return {
        index: selectedIndex,
        indexFraction: indexFraction,
        items: items,
        current: current
      };
    }
  }
}

function getScrollLeft(current, index) {
  if (current) {
    var items = current.querySelectorAll('ul > li');
    var item = items[Math.max(0, Math.min(items.length - 1, index))];

    if (item) {
      var itemOffsetCenter = item.offsetLeft + item.offsetWidth / 2;
      return itemOffsetCenter - current.offsetWidth / 2;
    }
  }
}

var FilmComposer =
/*#__PURE__*/
function (_React$Component) {
  _inherits(FilmComposer, _React$Component);

  function FilmComposer(props) {
    var _this;

    _classCallCheck(this, FilmComposer);

    _this = _possibleConstructorReturn(this, _getPrototypeOf(FilmComposer).call(this, props));
    _this.handleScroll = _this.handleScroll.bind(_assertThisInitialized(_assertThisInitialized(_this)));
    _this.handleScrollToEnd = _this.handleScrollToEnd.bind(_assertThisInitialized(_assertThisInitialized(_this)));
    _this.state = {
      filmStrip: null,
      scrollLeft: null,
      context: {
        _setFilmStripRef: function _setFilmStripRef(filmStrip) {
          return _this.setState(function () {
            return {
              filmStrip: filmStrip
            };
          });
        },
        _setNumItems: function _setNumItems(numItems) {
          _this.setState(function (_ref) {
            var context = _ref.context;
            return {
              context: _objectSpread({}, context, {
                numItems: numItems
              })
            };
          });
        },
        numItems: 0,
        scrollBarPercentage: '0%',
        scrollBarWidth: '0%',
        scrolling: false,
        scrollTo: function scrollTo(_scrollTo) {
          _this.setState(function (state) {
            var view = getView(state.filmStrip, state.scrollLeft);

            if (view) {
              var index = view.index,
                  indexFraction = view.indexFraction;

              var targetIndex = _scrollTo({
                index: index,
                indexFraction: indexFraction
              });

              if (typeof targetIndex === 'number') {
                return {
                  scrollLeft: getScrollLeft(state.filmStrip, targetIndex)
                };
              }
            }
          });
        },
        scrollOneLeft: function scrollOneLeft() {
          _this.state.context.scrollTo(function (_ref2) {
            var indexFraction = _ref2.indexFraction;
            return Math.ceil(indexFraction) - 1;
          });
        },
        scrollOneRight: function scrollOneRight() {
          _this.state.context.scrollTo(function (_ref3) {
            var indexFraction = _ref3.indexFraction;
            return Math.floor(indexFraction) + 1;
          });
        }
      }
    };
    return _this;
  }

  _createClass(FilmComposer, [{
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      clearTimeout(this.scrollTimeout);
    }
  }, {
    key: "handleScroll",
    value: function handleScroll(_ref4) {
      var _this2 = this;

      var scrollBarPercentage = _ref4.fraction,
          initial = _ref4.initial,
          scrollBarWidth = _ref4.width;
      this.setState(function (_ref5) {
        var context = _ref5.context,
            filmStrip = _ref5.filmStrip,
            scrollLeft = _ref5.scrollLeft;
        var view = getView(filmStrip, scrollLeft);

        if (view) {
          var index = view.index,
              indexFraction = view.indexFraction;
          return {
            context: _objectSpread({}, context, {
              index: index,
              indexFraction: indexFraction,
              scrolling: !initial,
              scrollBarPercentage: scrollBarPercentage,
              scrollBarWidth: scrollBarWidth
            })
          };
        }
      });

      if (!initial) {
        clearTimeout(this.scrollTimeout);
        this.scrollTimeout = setTimeout(function () {
          _this2.setState(function (_ref6) {
            var context = _ref6.context;
            return {
              context: _objectSpread({}, context, {
                scrolling: false
              })
            };
          });
        }, 500);
      }
    }
  }, {
    key: "handleScrollToEnd",
    value: function handleScrollToEnd() {
      this.setState(function () {
        return {
          scrollLeft: null
        };
      });
    }
  }, {
    key: "render",
    value: function render() {
      var state = this.state;
      return _react.default.createElement(_Context.default.Provider, {
        value: state.context
      }, this.props.children, !!state.filmStrip && _react.default.createElement(_ScrollSpy.default, {
        onScroll: this.handleScroll,
        target: state.filmStrip
      }), typeof state.scrollLeft === 'number' && !!state.filmStrip && _react.default.createElement(_ScrollTo.default, {
        onEnd: this.handleScrollToEnd,
        scrollLeft: state.scrollLeft,
        target: state.filmStrip
      }));
    }
  }]);

  return FilmComposer;
}(_react.default.Component);

exports.default = FilmComposer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Db21wb3Nlci5qcyJdLCJuYW1lcyI6WyJnZXRWaWV3IiwiY3VycmVudCIsInNjcm9sbGluZ1RvIiwic2Nyb2xsTGVmdCIsIml0ZW1zIiwicXVlcnlTZWxlY3RvckFsbCIsInNjcm9sbENlbnRlciIsIm9mZnNldFdpZHRoIiwiaW5kZXgiLCJzbGljZSIsImNhbGwiLCJpdGVtIiwib2Zmc2V0Q2VudGVyIiwib2Zmc2V0TGVmdCIsIk1hdGgiLCJhYnMiLCJpbmRleEZyYWN0aW9uIiwicm91bmQiLCJzZWxlY3RlZEluZGV4Iiwic2Nyb2xsV2lkdGgiLCJsZW5ndGgiLCJnZXRTY3JvbGxMZWZ0IiwibWF4IiwibWluIiwiaXRlbU9mZnNldENlbnRlciIsIkZpbG1Db21wb3NlciIsInByb3BzIiwiaGFuZGxlU2Nyb2xsIiwiYmluZCIsImhhbmRsZVNjcm9sbFRvRW5kIiwic3RhdGUiLCJmaWxtU3RyaXAiLCJjb250ZXh0IiwiX3NldEZpbG1TdHJpcFJlZiIsInNldFN0YXRlIiwiX3NldE51bUl0ZW1zIiwibnVtSXRlbXMiLCJzY3JvbGxCYXJQZXJjZW50YWdlIiwic2Nyb2xsQmFyV2lkdGgiLCJzY3JvbGxpbmciLCJzY3JvbGxUbyIsInZpZXciLCJ0YXJnZXRJbmRleCIsInNjcm9sbE9uZUxlZnQiLCJjZWlsIiwic2Nyb2xsT25lUmlnaHQiLCJmbG9vciIsImNsZWFyVGltZW91dCIsInNjcm9sbFRpbWVvdXQiLCJmcmFjdGlvbiIsImluaXRpYWwiLCJ3aWR0aCIsInNldFRpbWVvdXQiLCJjaGlsZHJlbiIsIlJlYWN0IiwiQ29tcG9uZW50Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUEsU0FBU0EsT0FBVCxDQUFpQkMsT0FBakIsRUFBMEJDLFdBQTFCLEVBQXVDO0FBQ3JDLE1BQUlELE9BQUosRUFBYTtBQUNYLFFBQU1FLFVBQVUsR0FBR0QsV0FBVyxJQUFJRCxPQUFPLENBQUNFLFVBQTFDO0FBQ0EsUUFBTUMsS0FBSyxHQUFHSCxPQUFPLENBQUNJLGdCQUFSLENBQXlCLFNBQXpCLENBQWQ7QUFDQSxRQUFNQyxZQUFZLEdBQUdILFVBQVUsR0FBR0YsT0FBTyxDQUFDTSxXQUFSLEdBQXNCLENBQXhEO0FBQ0EsUUFBTUMsS0FBSyxHQUFHLG1CQUFLLEdBQUdDLEtBQUgsQ0FBU0MsSUFBVCxDQUFjTixLQUFkLENBQUwsRUFBMkIsVUFBQU8sSUFBSSxFQUFJO0FBQy9DLFVBQU1DLFlBQVksR0FBR0QsSUFBSSxDQUFDRSxVQUFMLEdBQWtCRixJQUFJLENBQUNKLFdBQUwsR0FBbUIsQ0FBMUQ7QUFFQSxhQUFPLElBQUlPLElBQUksQ0FBQ0MsR0FBTCxDQUFTVCxZQUFZLEdBQUdNLFlBQXhCLENBQVg7QUFDRCxLQUphLENBQWQ7O0FBTUEsUUFBSSxDQUFDSixLQUFMLEVBQVk7QUFDVixVQUFNRyxJQUFJLEdBQUdQLEtBQUssQ0FBQ0ksS0FBRCxDQUFsQjtBQUNBLFVBQU1JLFlBQVksR0FBR0QsSUFBSSxDQUFDRSxVQUFMLEdBQWtCRixJQUFJLENBQUNKLFdBQUwsR0FBbUIsQ0FBMUQ7QUFDQSxVQUFJUyxhQUFhLEdBQUdSLEtBQUssR0FBRyxDQUFDRixZQUFZLEdBQUdNLFlBQWhCLElBQWdDRCxJQUFJLENBQUNKLFdBQWpFLENBSFUsQ0FLVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsVUFBSVMsYUFBYSxHQUFHLENBQWhCLEdBQW9CLEdBQXBCLElBQTJCQSxhQUFhLEdBQUcsQ0FBaEIsR0FBb0IsR0FBbkQsRUFBd0Q7QUFDdERBLFFBQUFBLGFBQWEsR0FBR0YsSUFBSSxDQUFDRyxLQUFMLENBQVdELGFBQVgsQ0FBaEI7QUFDRDs7QUFFRCxVQUFJRSxhQUFKOztBQUVBLFVBQUlmLFVBQVUsS0FBSyxDQUFuQixFQUFzQjtBQUNwQmUsUUFBQUEsYUFBYSxHQUFHLENBQWhCO0FBQ0QsT0FGRCxNQUVPLElBQUlmLFVBQVUsSUFBSUYsT0FBTyxDQUFDa0IsV0FBUixHQUFzQmxCLE9BQU8sQ0FBQ00sV0FBaEQsRUFBNkQ7QUFDbEVXLFFBQUFBLGFBQWEsR0FBR2QsS0FBSyxDQUFDZ0IsTUFBTixHQUFlLENBQS9CO0FBQ0QsT0FGTSxNQUVBO0FBQ0xGLFFBQUFBLGFBQWEsR0FBR0osSUFBSSxDQUFDRyxLQUFMLENBQVdELGFBQVgsQ0FBaEI7QUFDRDs7QUFFRCxhQUFPO0FBQ0xSLFFBQUFBLEtBQUssRUFBRVUsYUFERjtBQUVMRixRQUFBQSxhQUFhLEVBQWJBLGFBRks7QUFHTFosUUFBQUEsS0FBSyxFQUFMQSxLQUhLO0FBSUxILFFBQUFBLE9BQU8sRUFBUEE7QUFKSyxPQUFQO0FBTUQ7QUFDRjtBQUNGOztBQUVELFNBQVNvQixhQUFULENBQXVCcEIsT0FBdkIsRUFBZ0NPLEtBQWhDLEVBQXVDO0FBQ3JDLE1BQUlQLE9BQUosRUFBYTtBQUNYLFFBQU1HLEtBQUssR0FBR0gsT0FBTyxDQUFDSSxnQkFBUixDQUF5QixTQUF6QixDQUFkO0FBQ0EsUUFBTU0sSUFBSSxHQUFHUCxLQUFLLENBQUNVLElBQUksQ0FBQ1EsR0FBTCxDQUFTLENBQVQsRUFBWVIsSUFBSSxDQUFDUyxHQUFMLENBQVNuQixLQUFLLENBQUNnQixNQUFOLEdBQWUsQ0FBeEIsRUFBMkJaLEtBQTNCLENBQVosQ0FBRCxDQUFsQjs7QUFFQSxRQUFJRyxJQUFKLEVBQVU7QUFDUixVQUFNYSxnQkFBZ0IsR0FBR2IsSUFBSSxDQUFDRSxVQUFMLEdBQWtCRixJQUFJLENBQUNKLFdBQUwsR0FBbUIsQ0FBOUQ7QUFFQSxhQUFPaUIsZ0JBQWdCLEdBQUd2QixPQUFPLENBQUNNLFdBQVIsR0FBc0IsQ0FBaEQ7QUFDRDtBQUNGO0FBQ0Y7O0lBRW9Ca0IsWTs7Ozs7QUFDbkIsd0JBQVlDLEtBQVosRUFBbUI7QUFBQTs7QUFBQTs7QUFDakIsc0ZBQU1BLEtBQU47QUFFQSxVQUFLQyxZQUFMLEdBQW9CLE1BQUtBLFlBQUwsQ0FBa0JDLElBQWxCLHVEQUFwQjtBQUNBLFVBQUtDLGlCQUFMLEdBQXlCLE1BQUtBLGlCQUFMLENBQXVCRCxJQUF2Qix1REFBekI7QUFFQSxVQUFLRSxLQUFMLEdBQWE7QUFDWEMsTUFBQUEsU0FBUyxFQUFFLElBREE7QUFFWDVCLE1BQUFBLFVBQVUsRUFBRSxJQUZEO0FBR1g2QixNQUFBQSxPQUFPLEVBQUU7QUFDUEMsUUFBQUEsZ0JBQWdCLEVBQUUsMEJBQUFGLFNBQVM7QUFBQSxpQkFBSSxNQUFLRyxRQUFMLENBQWM7QUFBQSxtQkFBTztBQUFFSCxjQUFBQSxTQUFTLEVBQVRBO0FBQUYsYUFBUDtBQUFBLFdBQWQsQ0FBSjtBQUFBLFNBRHBCO0FBRVBJLFFBQUFBLFlBQVksRUFBRSxzQkFBQUMsUUFBUSxFQUFJO0FBQ3hCLGdCQUFLRixRQUFMLENBQWM7QUFBQSxnQkFBR0YsT0FBSCxRQUFHQSxPQUFIO0FBQUEsbUJBQWtCO0FBQzlCQSxjQUFBQSxPQUFPLG9CQUNGQSxPQURFO0FBRUxJLGdCQUFBQSxRQUFRLEVBQVJBO0FBRks7QUFEdUIsYUFBbEI7QUFBQSxXQUFkO0FBTUQsU0FUTTtBQVVQQSxRQUFBQSxRQUFRLEVBQUUsQ0FWSDtBQVdQQyxRQUFBQSxtQkFBbUIsRUFBRSxJQVhkO0FBWVBDLFFBQUFBLGNBQWMsRUFBRSxJQVpUO0FBYVBDLFFBQUFBLFNBQVMsRUFBRSxLQWJKO0FBY1BDLFFBQUFBLFFBQVEsRUFBRSxrQkFBQUEsU0FBUSxFQUFJO0FBQ3BCLGdCQUFLTixRQUFMLENBQWMsVUFBQUosS0FBSyxFQUFJO0FBQ3JCLGdCQUFNVyxJQUFJLEdBQUd6QyxPQUFPLENBQUM4QixLQUFLLENBQUNDLFNBQVAsRUFBa0JELEtBQUssQ0FBQzNCLFVBQXhCLENBQXBCOztBQUVBLGdCQUFJc0MsSUFBSixFQUFVO0FBQUEsa0JBQ0FqQyxLQURBLEdBQ3lCaUMsSUFEekIsQ0FDQWpDLEtBREE7QUFBQSxrQkFDT1EsYUFEUCxHQUN5QnlCLElBRHpCLENBQ096QixhQURQOztBQUVSLGtCQUFNMEIsV0FBVyxHQUFHRixTQUFRLENBQUM7QUFBRWhDLGdCQUFBQSxLQUFLLEVBQUxBLEtBQUY7QUFBU1EsZ0JBQUFBLGFBQWEsRUFBYkE7QUFBVCxlQUFELENBQTVCOztBQUVBLGtCQUFJLE9BQU8wQixXQUFQLEtBQXVCLFFBQTNCLEVBQXFDO0FBQ25DLHVCQUFPO0FBQUV2QyxrQkFBQUEsVUFBVSxFQUFFa0IsYUFBYSxDQUFDUyxLQUFLLENBQUNDLFNBQVAsRUFBa0JXLFdBQWxCO0FBQTNCLGlCQUFQO0FBQ0Q7QUFDRjtBQUNGLFdBWEQ7QUFZRCxTQTNCTTtBQTRCUEMsUUFBQUEsYUFBYSxFQUFFLHlCQUFNO0FBQ25CLGdCQUFLYixLQUFMLENBQVdFLE9BQVgsQ0FBbUJRLFFBQW5CLENBQTRCO0FBQUEsZ0JBQUd4QixhQUFILFNBQUdBLGFBQUg7QUFBQSxtQkFBdUJGLElBQUksQ0FBQzhCLElBQUwsQ0FBVTVCLGFBQVYsSUFBMkIsQ0FBbEQ7QUFBQSxXQUE1QjtBQUNELFNBOUJNO0FBK0JQNkIsUUFBQUEsY0FBYyxFQUFFLDBCQUFNO0FBQ3BCLGdCQUFLZixLQUFMLENBQVdFLE9BQVgsQ0FBbUJRLFFBQW5CLENBQTRCO0FBQUEsZ0JBQUd4QixhQUFILFNBQUdBLGFBQUg7QUFBQSxtQkFBdUJGLElBQUksQ0FBQ2dDLEtBQUwsQ0FBVzlCLGFBQVgsSUFBNEIsQ0FBbkQ7QUFBQSxXQUE1QjtBQUNEO0FBakNNO0FBSEUsS0FBYjtBQU5pQjtBQTZDbEI7Ozs7MkNBRXNCO0FBQ3JCK0IsTUFBQUEsWUFBWSxDQUFDLEtBQUtDLGFBQU4sQ0FBWjtBQUNEOzs7d0NBRStFO0FBQUE7O0FBQUEsVUFBdkRYLG1CQUF1RCxTQUFqRVksUUFBaUU7QUFBQSxVQUFsQ0MsT0FBa0MsU0FBbENBLE9BQWtDO0FBQUEsVUFBbEJaLGNBQWtCLFNBQXpCYSxLQUF5QjtBQUM5RSxXQUFLakIsUUFBTCxDQUFjLGlCQUF3QztBQUFBLFlBQXJDRixPQUFxQyxTQUFyQ0EsT0FBcUM7QUFBQSxZQUE1QkQsU0FBNEIsU0FBNUJBLFNBQTRCO0FBQUEsWUFBakI1QixVQUFpQixTQUFqQkEsVUFBaUI7QUFDcEQsWUFBTXNDLElBQUksR0FBR3pDLE9BQU8sQ0FBQytCLFNBQUQsRUFBWTVCLFVBQVosQ0FBcEI7O0FBRUEsWUFBSXNDLElBQUosRUFBVTtBQUFBLGNBQ0FqQyxLQURBLEdBQ3lCaUMsSUFEekIsQ0FDQWpDLEtBREE7QUFBQSxjQUNPUSxhQURQLEdBQ3lCeUIsSUFEekIsQ0FDT3pCLGFBRFA7QUFHUixpQkFBTztBQUNMZ0IsWUFBQUEsT0FBTyxvQkFDRkEsT0FERTtBQUVMeEIsY0FBQUEsS0FBSyxFQUFMQSxLQUZLO0FBR0xRLGNBQUFBLGFBQWEsRUFBYkEsYUFISztBQUlMdUIsY0FBQUEsU0FBUyxFQUFFLENBQUNXLE9BSlA7QUFLTGIsY0FBQUEsbUJBQW1CLEVBQW5CQSxtQkFMSztBQU1MQyxjQUFBQSxjQUFjLEVBQWRBO0FBTks7QUFERixXQUFQO0FBVUQ7QUFDRixPQWpCRDs7QUFtQkEsVUFBSSxDQUFDWSxPQUFMLEVBQWM7QUFDWkgsUUFBQUEsWUFBWSxDQUFDLEtBQUtDLGFBQU4sQ0FBWjtBQUNBLGFBQUtBLGFBQUwsR0FBcUJJLFVBQVUsQ0FBQyxZQUFNO0FBQ3BDLFVBQUEsTUFBSSxDQUFDbEIsUUFBTCxDQUFjO0FBQUEsZ0JBQUdGLE9BQUgsU0FBR0EsT0FBSDtBQUFBLG1CQUFrQjtBQUM5QkEsY0FBQUEsT0FBTyxvQkFDRkEsT0FERTtBQUVMTyxnQkFBQUEsU0FBUyxFQUFFO0FBRk47QUFEdUIsYUFBbEI7QUFBQSxXQUFkO0FBTUQsU0FQOEIsRUFPNUIsR0FQNEIsQ0FBL0I7QUFRRDtBQUNGOzs7d0NBRW1CO0FBQ2xCLFdBQUtMLFFBQUwsQ0FBYztBQUFBLGVBQU87QUFBRS9CLFVBQUFBLFVBQVUsRUFBRTtBQUFkLFNBQVA7QUFBQSxPQUFkO0FBQ0Q7Ozs2QkFFUTtBQUFBLFVBQ0MyQixLQURELEdBQ1csSUFEWCxDQUNDQSxLQUREO0FBR1AsYUFDRSw2QkFBQyxnQkFBRCxDQUFTLFFBQVQ7QUFBa0IsUUFBQSxLQUFLLEVBQUdBLEtBQUssQ0FBQ0U7QUFBaEMsU0FDSSxLQUFLTixLQUFMLENBQVcyQixRQURmLEVBR0ksQ0FBQyxDQUFDdkIsS0FBSyxDQUFDQyxTQUFSLElBQ0UsNkJBQUMsa0JBQUQ7QUFDRSxRQUFBLFFBQVEsRUFBRyxLQUFLSixZQURsQjtBQUVFLFFBQUEsTUFBTSxFQUFHRyxLQUFLLENBQUNDO0FBRmpCLFFBSk4sRUFVSSxPQUFPRCxLQUFLLENBQUMzQixVQUFiLEtBQTRCLFFBQTVCLElBQ0csQ0FBQyxDQUFDMkIsS0FBSyxDQUFDQyxTQURYLElBR0UsNkJBQUMsaUJBQUQ7QUFDRSxRQUFBLEtBQUssRUFBRyxLQUFLRixpQkFEZjtBQUVFLFFBQUEsVUFBVSxFQUFHQyxLQUFLLENBQUMzQixVQUZyQjtBQUdFLFFBQUEsTUFBTSxFQUFHMkIsS0FBSyxDQUFDQztBQUhqQixRQWJOLENBREY7QUFzQkQ7Ozs7RUFsSHVDdUIsZUFBTUMsUyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5cbmltcG9ydCBiZXN0IGZyb20gJy4vYmVzdCc7XG5pbXBvcnQgQ29udGV4dCBmcm9tICcuL0NvbnRleHQnO1xuaW1wb3J0IFNjcm9sbFNweSBmcm9tICcuL1Njcm9sbFNweSc7XG5pbXBvcnQgU2Nyb2xsVG8gZnJvbSAnLi9TY3JvbGxUbyc7XG5cbmZ1bmN0aW9uIGdldFZpZXcoY3VycmVudCwgc2Nyb2xsaW5nVG8pIHtcbiAgaWYgKGN1cnJlbnQpIHtcbiAgICBjb25zdCBzY3JvbGxMZWZ0ID0gc2Nyb2xsaW5nVG8gfHwgY3VycmVudC5zY3JvbGxMZWZ0O1xuICAgIGNvbnN0IGl0ZW1zID0gY3VycmVudC5xdWVyeVNlbGVjdG9yQWxsKCd1bCA+IGxpJyk7XG4gICAgY29uc3Qgc2Nyb2xsQ2VudGVyID0gc2Nyb2xsTGVmdCArIGN1cnJlbnQub2Zmc2V0V2lkdGggLyAyO1xuICAgIGNvbnN0IGluZGV4ID0gYmVzdChbXS5zbGljZS5jYWxsKGl0ZW1zKSwgaXRlbSA9PiB7XG4gICAgICBjb25zdCBvZmZzZXRDZW50ZXIgPSBpdGVtLm9mZnNldExlZnQgKyBpdGVtLm9mZnNldFdpZHRoIC8gMjtcblxuICAgICAgcmV0dXJuIDEgLyBNYXRoLmFicyhzY3JvbGxDZW50ZXIgLSBvZmZzZXRDZW50ZXIpO1xuICAgIH0pO1xuXG4gICAgaWYgKH5pbmRleCkge1xuICAgICAgY29uc3QgaXRlbSA9IGl0ZW1zW2luZGV4XTtcbiAgICAgIGNvbnN0IG9mZnNldENlbnRlciA9IGl0ZW0ub2Zmc2V0TGVmdCArIGl0ZW0ub2Zmc2V0V2lkdGggLyAyO1xuICAgICAgbGV0IGluZGV4RnJhY3Rpb24gPSBpbmRleCArIChzY3JvbGxDZW50ZXIgLSBvZmZzZXRDZW50ZXIpIC8gaXRlbS5vZmZzZXRXaWR0aDtcblxuICAgICAgLy8gV2UgXCJmaXhcIiBpbmRleEZyYWN0aW9uIGlmIHRoZSB2aWV3cG9ydCBpcyBhdCB0aGUgc3RhcnQvZW5kIG9mIHRoZSBjb250ZW50XG4gICAgICAvLyBUaGlzIGlzIHRvIHNpbXBsaWZ5IGNvZGUgdGhhdCB1c2UgTWF0aC5yb3VuZChpbmRleEZyYWN0aW9uKSB0byBmaW5kIHRoZSBjdXJyZW50IGluZGV4XG4gICAgICAvLyBpZiAoc2Nyb2xsTGVmdCA9PT0gMCkge1xuICAgICAgLy8gICBpbmRleEZyYWN0aW9uID0gMDtcbiAgICAgIC8vIH0gZWxzZSBpZiAoc2Nyb2xsTGVmdCA+PSBjdXJyZW50LnNjcm9sbFdpZHRoIC0gY3VycmVudC5vZmZzZXRXaWR0aCkge1xuICAgICAgLy8gICBpbmRleEZyYWN0aW9uID0gaXRlbXMubGVuZ3RoIC0gMTtcbiAgICAgIC8vIH0gZWxzZSBpZiAoaW5kZXhGcmFjdGlvbiAlIDEgPiAuOTkgfHwgaW5kZXhGcmFjdGlvbiAlIDEgPCAuMDEpIHtcbiAgICAgIC8vICAgaW5kZXhGcmFjdGlvbiA9IE1hdGgucm91bmQoaW5kZXhGcmFjdGlvbik7XG4gICAgICAvLyB9XG5cbiAgICAgIGlmIChpbmRleEZyYWN0aW9uICUgMSA+IC45OSB8fCBpbmRleEZyYWN0aW9uICUgMSA8IC4wMSkge1xuICAgICAgICBpbmRleEZyYWN0aW9uID0gTWF0aC5yb3VuZChpbmRleEZyYWN0aW9uKTtcbiAgICAgIH1cblxuICAgICAgbGV0IHNlbGVjdGVkSW5kZXg7XG5cbiAgICAgIGlmIChzY3JvbGxMZWZ0ID09PSAwKSB7XG4gICAgICAgIHNlbGVjdGVkSW5kZXggPSAwO1xuICAgICAgfSBlbHNlIGlmIChzY3JvbGxMZWZ0ID49IGN1cnJlbnQuc2Nyb2xsV2lkdGggLSBjdXJyZW50Lm9mZnNldFdpZHRoKSB7XG4gICAgICAgIHNlbGVjdGVkSW5kZXggPSBpdGVtcy5sZW5ndGggLSAxO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc2VsZWN0ZWRJbmRleCA9IE1hdGgucm91bmQoaW5kZXhGcmFjdGlvbik7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIGluZGV4OiBzZWxlY3RlZEluZGV4LFxuICAgICAgICBpbmRleEZyYWN0aW9uLFxuICAgICAgICBpdGVtcyxcbiAgICAgICAgY3VycmVudFxuICAgICAgfTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0U2Nyb2xsTGVmdChjdXJyZW50LCBpbmRleCkge1xuICBpZiAoY3VycmVudCkge1xuICAgIGNvbnN0IGl0ZW1zID0gY3VycmVudC5xdWVyeVNlbGVjdG9yQWxsKCd1bCA+IGxpJyk7XG4gICAgY29uc3QgaXRlbSA9IGl0ZW1zW01hdGgubWF4KDAsIE1hdGgubWluKGl0ZW1zLmxlbmd0aCAtIDEsIGluZGV4KSldO1xuXG4gICAgaWYgKGl0ZW0pIHtcbiAgICAgIGNvbnN0IGl0ZW1PZmZzZXRDZW50ZXIgPSBpdGVtLm9mZnNldExlZnQgKyBpdGVtLm9mZnNldFdpZHRoIC8gMjtcblxuICAgICAgcmV0dXJuIGl0ZW1PZmZzZXRDZW50ZXIgLSBjdXJyZW50Lm9mZnNldFdpZHRoIC8gMjtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRmlsbUNvbXBvc2VyIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50IHtcbiAgY29uc3RydWN0b3IocHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcyk7XG5cbiAgICB0aGlzLmhhbmRsZVNjcm9sbCA9IHRoaXMuaGFuZGxlU2Nyb2xsLmJpbmQodGhpcyk7XG4gICAgdGhpcy5oYW5kbGVTY3JvbGxUb0VuZCA9IHRoaXMuaGFuZGxlU2Nyb2xsVG9FbmQuYmluZCh0aGlzKTtcblxuICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICBmaWxtU3RyaXA6IG51bGwsXG4gICAgICBzY3JvbGxMZWZ0OiBudWxsLFxuICAgICAgY29udGV4dDoge1xuICAgICAgICBfc2V0RmlsbVN0cmlwUmVmOiBmaWxtU3RyaXAgPT4gdGhpcy5zZXRTdGF0ZSgoKSA9PiAoeyBmaWxtU3RyaXAgfSkpLFxuICAgICAgICBfc2V0TnVtSXRlbXM6IG51bUl0ZW1zID0+IHtcbiAgICAgICAgICB0aGlzLnNldFN0YXRlKCh7IGNvbnRleHQgfSkgPT4gKHtcbiAgICAgICAgICAgIGNvbnRleHQ6IHtcbiAgICAgICAgICAgICAgLi4uY29udGV4dCxcbiAgICAgICAgICAgICAgbnVtSXRlbXNcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KSk7XG4gICAgICAgIH0sXG4gICAgICAgIG51bUl0ZW1zOiAwLFxuICAgICAgICBzY3JvbGxCYXJQZXJjZW50YWdlOiAnMCUnLFxuICAgICAgICBzY3JvbGxCYXJXaWR0aDogJzAlJyxcbiAgICAgICAgc2Nyb2xsaW5nOiBmYWxzZSxcbiAgICAgICAgc2Nyb2xsVG86IHNjcm9sbFRvID0+IHtcbiAgICAgICAgICB0aGlzLnNldFN0YXRlKHN0YXRlID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHZpZXcgPSBnZXRWaWV3KHN0YXRlLmZpbG1TdHJpcCwgc3RhdGUuc2Nyb2xsTGVmdCk7XG5cbiAgICAgICAgICAgIGlmICh2aWV3KSB7XG4gICAgICAgICAgICAgIGNvbnN0IHsgaW5kZXgsIGluZGV4RnJhY3Rpb24gfSA9IHZpZXc7XG4gICAgICAgICAgICAgIGNvbnN0IHRhcmdldEluZGV4ID0gc2Nyb2xsVG8oeyBpbmRleCwgaW5kZXhGcmFjdGlvbiB9KTtcblxuICAgICAgICAgICAgICBpZiAodHlwZW9mIHRhcmdldEluZGV4ID09PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgICAgIHJldHVybiB7IHNjcm9sbExlZnQ6IGdldFNjcm9sbExlZnQoc3RhdGUuZmlsbVN0cmlwLCB0YXJnZXRJbmRleCkgfTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9LFxuICAgICAgICBzY3JvbGxPbmVMZWZ0OiAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5zdGF0ZS5jb250ZXh0LnNjcm9sbFRvKCh7IGluZGV4RnJhY3Rpb24gfSkgPT4gTWF0aC5jZWlsKGluZGV4RnJhY3Rpb24pIC0gMSk7XG4gICAgICAgIH0sXG4gICAgICAgIHNjcm9sbE9uZVJpZ2h0OiAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5zdGF0ZS5jb250ZXh0LnNjcm9sbFRvKCh7IGluZGV4RnJhY3Rpb24gfSkgPT4gTWF0aC5mbG9vcihpbmRleEZyYWN0aW9uKSArIDEpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIGNsZWFyVGltZW91dCh0aGlzLnNjcm9sbFRpbWVvdXQpO1xuICB9XG5cbiAgaGFuZGxlU2Nyb2xsKHsgZnJhY3Rpb246IHNjcm9sbEJhclBlcmNlbnRhZ2UsIGluaXRpYWwsIHdpZHRoOiBzY3JvbGxCYXJXaWR0aCB9KSB7XG4gICAgdGhpcy5zZXRTdGF0ZSgoeyBjb250ZXh0LCBmaWxtU3RyaXAsIHNjcm9sbExlZnQgfSkgPT4ge1xuICAgICAgY29uc3QgdmlldyA9IGdldFZpZXcoZmlsbVN0cmlwLCBzY3JvbGxMZWZ0KTtcblxuICAgICAgaWYgKHZpZXcpIHtcbiAgICAgICAgY29uc3QgeyBpbmRleCwgaW5kZXhGcmFjdGlvbiB9ID0gdmlldztcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGNvbnRleHQ6IHtcbiAgICAgICAgICAgIC4uLmNvbnRleHQsXG4gICAgICAgICAgICBpbmRleCxcbiAgICAgICAgICAgIGluZGV4RnJhY3Rpb24sXG4gICAgICAgICAgICBzY3JvbGxpbmc6ICFpbml0aWFsLFxuICAgICAgICAgICAgc2Nyb2xsQmFyUGVyY2VudGFnZSxcbiAgICAgICAgICAgIHNjcm9sbEJhcldpZHRoXG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaWYgKCFpbml0aWFsKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5zY3JvbGxUaW1lb3V0KTtcbiAgICAgIHRoaXMuc2Nyb2xsVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKCh7IGNvbnRleHQgfSkgPT4gKHtcbiAgICAgICAgICBjb250ZXh0OiB7XG4gICAgICAgICAgICAuLi5jb250ZXh0LFxuICAgICAgICAgICAgc2Nyb2xsaW5nOiBmYWxzZVxuICAgICAgICAgIH1cbiAgICAgICAgfSkpO1xuICAgICAgfSwgNTAwKTtcbiAgICB9XG4gIH1cblxuICBoYW5kbGVTY3JvbGxUb0VuZCgpIHtcbiAgICB0aGlzLnNldFN0YXRlKCgpID0+ICh7IHNjcm9sbExlZnQ6IG51bGwgfSkpO1xuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHsgc3RhdGUgfSA9IHRoaXM7XG5cbiAgICByZXR1cm4gKFxuICAgICAgPENvbnRleHQuUHJvdmlkZXIgdmFsdWU9eyBzdGF0ZS5jb250ZXh0IH0+XG4gICAgICAgIHsgdGhpcy5wcm9wcy5jaGlsZHJlbiB9XG4gICAgICAgIHtcbiAgICAgICAgICAhIXN0YXRlLmZpbG1TdHJpcCAmJlxuICAgICAgICAgICAgPFNjcm9sbFNweVxuICAgICAgICAgICAgICBvblNjcm9sbD17IHRoaXMuaGFuZGxlU2Nyb2xsIH1cbiAgICAgICAgICAgICAgdGFyZ2V0PXsgc3RhdGUuZmlsbVN0cmlwIH1cbiAgICAgICAgICAgIC8+XG4gICAgICAgIH1cbiAgICAgICAge1xuICAgICAgICAgIHR5cGVvZiBzdGF0ZS5zY3JvbGxMZWZ0ID09PSAnbnVtYmVyJ1xuICAgICAgICAgICYmICEhc3RhdGUuZmlsbVN0cmlwXG4gICAgICAgICAgJiZcbiAgICAgICAgICAgIDxTY3JvbGxUb1xuICAgICAgICAgICAgICBvbkVuZD17IHRoaXMuaGFuZGxlU2Nyb2xsVG9FbmQgfVxuICAgICAgICAgICAgICBzY3JvbGxMZWZ0PXsgc3RhdGUuc2Nyb2xsTGVmdCB9XG4gICAgICAgICAgICAgIHRhcmdldD17IHN0YXRlLmZpbG1TdHJpcCB9XG4gICAgICAgICAgICAvPlxuICAgICAgICB9XG4gICAgICA8L0NvbnRleHQuUHJvdmlkZXI+XG4gICAgKTtcbiAgfVxufVxuIl19